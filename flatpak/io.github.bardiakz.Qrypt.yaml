id: io.github.bardiakz.Qrypt
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: qrypt
separate-locales: false
#appstream-compose: false
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --share=network
  - --filesystem=xdg-documents
  - --device=dri
cleanup:
  - /include
  - /lib/pkgconfig
  - /man
  - /share/doc
  - /share/man
  - "*.a"
  - "*.la"
  - /git_repo
  - /io.github.bardiakz.Qrypt.desktop
modules:
  - name: liboqs
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DOQS_BUILD_ONLY_LIB=ON
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DBUILD_SHARED_LIBS=ON
    sources:
      - type: git
        url: https://github.com/open-quantum-safe/liboqs.git
        tag: 0.14.0
  - name: lz4
    buildsystem: simple
    build-commands:
      - make -j$FLATPAK_BUILDER_N_JOBS
      - make install PREFIX=/app
    sources:
      - type: git
        url: https://github.com/lz4/lz4.git
        tag: v1.10.0 # Latest stable
  - name: brotli
    buildsystem: cmake
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DBUILD_SHARED_LIBS=ON
    sources:
      - type: git
        url: https://github.com/google/brotli.git
        tag: v1.1.0
  - name: zstd
    buildsystem: simple
    build-commands:
      - cmake -S build/cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/app -DBUILD_SHARED_LIBS=ON -DZSTD_BUILD_STATIC=ON
      - cmake --build build -j$FLATPAK_BUILDER_N_JOBS
      - cmake --install build
    sources:
      - type: git
        url: https://github.com/facebook/zstd.git
        tag: v1.5.7
  - name: qrypt
    buildsystem: simple
    build-commands:
      # Copy prebuilt Qrypt binary
      - cp -r Qrypt /app/
      - chmod +x /app/Qrypt/qrypt

      # Create bin folder and symlink
      - mkdir -p /app/bin
      - ln -s /app/Qrypt/qrypt /app/bin/qrypt

      # Copy shared libraries if any
      - cp /app/lib/*.so /app/Qrypt/lib/ || true

      # Handle .desktop file
      - install -Dm644 git_repo/data/io.github.bardiakz.Qrypt.desktop \
        "${FLATPAK_DEST}/share/applications/io.github.bardiakz.Qrypt.desktop"
      - desktop-file-edit "${FLATPAK_DEST}/share/applications/io.github.bardiakz.Qrypt.desktop" \
        --set-icon=io.github.bardiakz.Qrypt

      # Install icon
      - install -Dm644 git_repo/assets/icon/qrypt_icon.png \
        "${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/io.github.bardiakz.Qrypt.png"

      # Install metainfo
      - install -Dm644 git_repo/data/io.github.bardiakz.Qrypt.metainfo.xml \
        /app/share/metainfo/io.github.bardiakz.Qrypt.metainfo.xml

      # Install screenshots (robust version)
      - mkdir -p "${FLATPAK_DEST}/share/metainfo/screenshots"
      - |
        for f in git_repo/flatpak/screenshots/*.png; do
          [ -e "$f" ] && install -Dm644 "$f" "${FLATPAK_DEST}/share/metainfo/screenshots/$(basename $f)"
        done

    sources:
      # Prebuilt x86_64 tar.gz
      - type: archive
        only-arches: [ x86_64 ]
        dest: Qrypt
        url: https://github.com/bardiakz/qrypt/releases/download/v4.4.6/qrypt-linux-x86_64.tar.gz
        sha256: eb18b8264650a3fa093a8e2bbee96344712788a3c8ba7f6bf32750960247f958
        strip-components: 1
        x-checker-data:
          type: json
          url: https://api.github.com/repos/bardiakz/qrypt/releases/latest
          tag-query: .tag_name
          timestamp-query: .published_at
          version-query: $tag | sub("^[vV]"; "")
          url-query: '"https://github.com/bardiakz/qrypt/releases/download/\($tag)/qrypt-linux-x86_64.tar.gz"'

      # Git repo for .desktop, icons, and screenshots
      - type: git
        dest: git_repo
        url: https://github.com/bardiakz/qrypt.git
        branch: main
        x-checker-data:
          type: git
          tag-pattern: ^v([0-9.]+)$
